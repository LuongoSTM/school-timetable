// Updated timetable data with corrected Week B data
const timetableData = {
    "weekA": {
        "MONDAY": {
            "Form Time": {
                "time": "09:00 - 09:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Form Time",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "Form Time",
                        "room": "A2"
                    }
                }
            },
            "1": {
                "time": "09:30 - 10:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "12 DT Textile",
                        "room": "T1"
                    },
                    "Ms N Jenkins": {
                        "subject": "11 Photography",
                        "room": "A1"
                    }
                }
            },
            "2": {
                "time": "10:30 - 11:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "12 / 13 Art",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "9S DT",
                        "room": "T1"
                    }
                }
            },
            "3": {
                "time": "11:30 - 12:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "9M",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "",
                        "room": ""
                    }
                }
            },
            "4a": {
                "time": "12:30 - 13:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "9A",
                        "room": "A1"
                    }
                }
            },
            "4b": {
                "time": "13:30 - 14:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Lunch",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "Lunch",
                        "room": ""
                    }
                }
            },
            "5": {
                "time": "14:30 - 15:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "12 DT Textile",
                        "room": "T1"
                    },
                    "Ms N Jenkins": {
                        "subject": "10 Art",
                        "room": "A1"
                    }
                }
            }
        },
        "TUESDAY": {
            "Form Time": {
                "time": "09:00 - 09:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Form Time",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "Form Time",
                        "room": "A2"
                    }
                }
            },
            "1": {
                "time": "09:30 - 10:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "9S",
                        "room": "A2"
                    },
                    "Ms N Jenkins": {
                        "subject": "11 Photography",
                        "room": "A1"
                    }
                }
            },
            "2": {
                "time": "10:30 - 11:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "7AC",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "7AC DT",
                        "room": "A2"
                    }
                }
            },
            "3": {
                "time": "11:30 - 12:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "11 Art",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "",
                        "room": ""
                    }
                }
            },
            "4a": {
                "time": "12:30 - 13:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Lunch",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "Lunch",
                        "room": ""
                    }
                }
            },
            "4b": {
                "time": "13:30 - 14:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "8AC",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "8AC DT",
                        "room": "A2"
                    }
                }
            },
            "5": {
                "time": "14:30 - 15:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "9AC DT",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "",
                        "room": ""
                    }
                }
            }
        },
        "WEDNESDAY": {
            "Form Time": {
                "time": "09:00 - 09:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Form Time",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "Form Time",
                        "room": "A2"
                    }
                }
            },
            "1": {
                "time": "09:30 - 10:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "9HM Food",
                        "room": "HE1"
                    },
                    "Ms N Jenkins": {
                        "subject": "9C",
                        "room": "A2"
                    }
                }
            },
            "2": {
                "time": "10:30 - 11:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "7AC",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "7AC DT",
                        "room": "A2"
                    }
                }
            },
            "3": {
                "time": "11:30 - 12:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "11 Photography",
                        "room": "A1"
                    }
                }
            },
            "4a": {
                "time": "12:30 - 13:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Lunch",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "Lunch",
                        "room": ""
                    }
                }
            },
            "4b": {
                "time": "13:30 - 14:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "7H",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "7H DT",
                        "room": "A2"
                    }
                }
            },
            "5": {
                "time": "14:30 - 15:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "11 Art",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "",
                        "room": ""
                    }
                }
            }
        },
        "THURSDAY": {
            "Form Time": {
                "time": "09:00 - 09:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Form Time",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "Form Time",
                        "room": "A2"
                    }
                }
            },
            "1": {
                "time": "09:30 - 10:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "10 Art",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "9H",
                        "room": "A2"
                    }
                }
            },
            "2": {
                "time": "10:30 - 11:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "10 Art",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "",
                        "room": ""
                    }
                }
            },
            "3": {
                "time": "11:30 - 12:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "11 Art",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "",
                        "room": ""
                    }
                }
            },
            "4a": {
                "time": "12:30 - 13:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Lunch",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "Lunch",
                        "room": ""
                    }
                }
            },
            "4b": {
                "time": "13:30 - 14:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "12 / 13 Art",
                        "room": "A1"
                    }
                }
            },
            "5": {
                "time": "14:30 - 15:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "8S",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "8S DT",
                        "room": "A2"
                    }
                }
            }
        },
        "FRIDAY": {
            "Form Time": {
                "time": "09:00 - 09:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Form Time",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "Form Time",
                        "room": "A2"
                    }
                }
            },
            "1": {
                "time": "09:30 - 10:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "7MS",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "7MS DT",
                        "room": "A2"
                    }
                }
            },
            "2": {
                "time": "10:30 - 11:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "8HM",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "8HM DT",
                        "room": "A2"
                    }
                }
            },
            "3": {
                "time": "11:30 - 12:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "8AC",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "8AC DT",
                        "room": "A2"
                    }
                }
            },
            "4a": {
                "time": "12:30 - 13:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Lunch",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "Lunch",
                        "room": ""
                    }
                }
            },
            "4b": {
                "time": "13:30 - 14:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "7H",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "7H DT",
                        "room": "A2"
                    }
                }
            },
            "5": {
                "time": "14:30 - 15:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "9AC DT",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "12 / 13 Art",
                        "room": "A2"
                    }
                }
            }
        }
    },
    "weekB": {
        "MONDAY": {
            "Form Time": {
                "time": "09:00 - 09:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Form Time",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "Form Time",
                        "room": "A2"
                    }
                }
            },
            "1": {
                "time": "09:30 - 10:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "8S",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "8S DT",
                        "room": "A2"
                    }
                }
            },
            "2": {
                "time": "10:30 - 11:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "9S",
                        "room": "A2"
                    },
                    "Ms N Jenkins": {
                        "subject": "12 / 13 Art",
                        "room": "A1"
                    }
                }
            },
            "3": {
                "time": "11:30 - 12:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "7MS",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "7MS DT",
                        "room": "A2"
                    }
                }
            },
            "4a": {
                "time": "12:30 - 13:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "Lunch",
                        "room": ""
                    }
                }
            },
            "4b": {
                "time": "13:30 - 14:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Lunch",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "12 / 13 Art",
                        "room": "A1"
                    }
                }
            },
            "5": {
                "time": "14:30 - 15:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "9S Food",
                        "room": "HE1"
                    },
                    "Ms N Jenkins": {
                        "subject": "",
                        "room": ""
                    }
                }
            }
        },
        "TUESDAY": {
            "Form Time": {
                "time": "09:00 - 09:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Form Time",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "Form Time",
                        "room": "A2"
                    }
                }
            },
            "1": {
                "time": "09:30 - 10:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "10 Art",
                        "room": "A1"
                    }
                }
            },
            "2": {
                "time": "10:30 - 11:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "PSHE",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "PSHE",
                        "room": "A2"
                    }
                }
            },
            "3": {
                "time": "11:30 - 12:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "11 Photography",
                        "room": "A1"
                    }
                }
            },
            "4a": {
                "time": "12:30 - 13:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Lunch",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "Lunch",
                        "room": ""
                    }
                }
            },
            "4b": {
                "time": "13:30 - 14:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "12 / 13 Art",
                        "room": "A1"
                    }
                }
            },
            "5": {
                "time": "14:30 - 15:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "11 Art",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "",
                        "room": ""
                    }
                }
            }
        },
        "WEDNESDAY": {
            "Form Time": {
                "time": "09:00 - 09:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Form Time",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "Form Time",
                        "room": "A2"
                    }
                }
            },
            "1": {
                "time": "09:30 - 10:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "10 Art",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "",
                        "room": ""
                    }
                }
            },
            "2": {
                "time": "10:30 - 11:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "11 Art",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "9C",
                        "room": "A2"
                    }
                }
            },
            "3": {
                "time": "11:30 - 12:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "8S",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "8S DT",
                        "room": "A2"
                    }
                }
            },
            "4a": {
                "time": "12:30 - 13:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "9M",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "Lunch",
                        "room": ""
                    }
                }
            },
            "4b": {
                "time": "13:30 - 14:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Lunch",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "12 / 13 Art",
                        "room": "A1"
                    }
                }
            },
            "5": {
                "time": "14:30 - 15:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "9A",
                        "room": "A2"
                    }
                }
            }
        },
        "THURSDAY": {
            "Form Time": {
                "time": "09:00 - 09:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Form Time",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "Form Time",
                        "room": "A2"
                    }
                }
            },
            "1": {
                "time": "09:20 - 10:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "9S Food",
                        "room": "HE1"
                    },
                    "Ms N Jenkins": {
                        "subject": "",
                        "room": ""
                    }
                }
            },
            "2": {
                "time": "10:30 - 11:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "12 / 13 Art",
                        "room": "A2"
                    },
                    "Ms N Jenkins": {
                        "subject": "11 Photography",
                        "room": "A1"
                    }
                }
            },
            "3": {
                "time": "11:30 - 12:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "9AC DT",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "9H",
                        "room": "A2"
                    }
                }
            },
            "4a": {
                "time": "12:30 - 13:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Lunch",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "Lunch",
                        "room": ""
                    }
                }
            },
            "4b": {
                "time": "13:30 - 14:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "8HM",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "8HM DT",
                        "room": "A2"
                    }
                }
            },
            "5": {
                "time": "14:30 - 15:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "7MS",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "7MS DT",
                        "room": "A2"
                    }
                }
            }
        },
        "FRIDAY": {
            "Form Time": {
                "time": "09:00 - 09:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Form Time",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "Form Time",
                        "room": "A2"
                    }
                }
            },
            "1": {
                "time": "09:30 - 10:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "7AC",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "7AC DT",
                        "room": "A2"
                    }
                }
            },
            "2": {
                "time": "10:30 - 11:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "8AC",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "8AC DT",
                        "room": "A2"
                    }
                }
            },
            "3": {
                "time": "11:30 - 12:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "8MH",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "8HM DT",
                        "room": "A2"
                    }
                }
            },
            "4a": {
                "time": "12:30 - 13:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Lunch",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "Lunch",
                        "room": ""
                    }
                }
            },
            "4b": {
                "time": "13:30 - 14:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "7H",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "7H DT",
                        "room": "A2"
                    }
                }
            },
            "5": {
                "time": "14:30 - 15:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "9HM Food",
                        "room": "HE1"
                    },
                    "Ms N Jenkins": {
                        "subject": "9HM DT",
                        "room": "A2"
                    }
                }
            }
        }
    }
};

// Global variables - Updated start dates
let currentMode = 'auto';
let currentWeek = 'A';
let currentModalData = null;
const weekAStartDate = new Date(2025, 8, 1); // September 1, 2025 (month is 0-indexed)
const weekBStartDate = new Date(2025, 8, 8); // September 8, 2025 (month is 0-indexed)

// School term dates with corrected dates
const schoolTerms = [
    {
        name: "October Half Term",
        startDate: new Date(2025, 9, 27), // October 27, 2025
        endDate: new Date(2025, 9, 31)    // October 31, 2025
    },
    {
        name: "Christmas Term",
        startDate: new Date(2025, 11, 22), // December 22, 2025
        endDate: new Date(2026, 0, 2)      // January 2, 2026
    },
    {
        name: "February Half Term",
        startDate: new Date(2026, 1, 16), // February 16, 2026
        endDate: new Date(2026, 1, 20)    // February 20, 2026
    },
    {
        name: "Easter Term",
        startDate: new Date(2026, 2, 30), // March 30, 2026
        endDate: new Date(2026, 3, 10)    // April 10, 2026
    },
    {
        name: "May Half Term",
        startDate: new Date(2026, 4, 25), // May 25, 2026
        endDate: new Date(2026, 4, 29)    // May 29, 2026
    },
    {
        name: "Summer Term",
        startDate: new Date(2026, 6, 20), // July 20, 2026
        endDate: new Date(2026, 7, 31)    // August 31, 2026
    }
];

const teachers = ['Ms K Arakalian', 'Ms N Jenkins'];
const days = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY'];
const periods = ['Form Time', '1', '2', '3', '4a', '4b', '5'];

// Local storage functions for lesson requests
function getLessonRequestKey(week, day, period, teacher) {
    return `lesson_request_${week}_${day}_${period}_${teacher.replace(/\s+/g, '_')}`;
}

function saveLessonRequest(week, day, period, teacher, hasRequest, notes) {
    const key = getLessonRequestKey(week, day, period, teacher);
    const data = {
        hasRequest: hasRequest,
        notes: notes,
        timestamp: new Date().toISOString()
    };
    localStorage.setItem(key, JSON.stringify(data));
}

function getLessonRequest(week, day, period, teacher) {
    const key = getLessonRequestKey(week, day, period, teacher);
    const data = localStorage.getItem(key);
    if (data) {
        try {
            return JSON.parse(data);
        } catch (e) {
            return null;
        }
    }
    return null;
}

function clearLessonRequest(week, day, period, teacher) {
    const key = getLessonRequestKey(week, day, period, teacher);
    localStorage.removeItem(key);
}

// Utility functions
function isWeekA(date) {
    const diffTime = date.getTime() - weekAStartDate.getTime();
    const diffWeeks = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7));
    return diffWeeks % 2 === 0;
}

function getCurrentWeek() {
    if (currentMode === 'auto') {
        return isWeekA(new Date()) ? 'A' : 'B';
    }
    return currentWeek;
}

function formatDate(date) {
    const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    };
    return date.toLocaleDateString('en-US', options);
}

function formatTime(date) {
    return date.toLocaleTimeString('en-US', { 
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}

function getWeekStartDate(week, referenceDate = new Date()) {
    const today = new Date(referenceDate);
    today.setHours(0, 0, 0, 0);

    // Find Monday of the week of the reference date
    let daysToMonday = today.getDay() - 1;
    if (daysToMonday < 0) daysToMonday = 6;
    const mondayOfReferenceWeek = new Date(today);
    mondayOfReferenceWeek.setDate(today.getDate() - daysToMonday);

    const isReferenceWeekA = isWeekA(mondayOfReferenceWeek);
    const isTargetWeekA = week === 'A';

    if (isReferenceWeekA === isTargetWeekA) {
        return mondayOfReferenceWeek;
    } else {
        // If the week type doesn't match, move to the next week.
        const oneWeek = 7 * 24 * 60 * 60 * 1000;
        return new Date(mondayOfReferenceWeek.getTime() + oneWeek);
    }
}

function getDayDate(day, week) {
    const dayIndex = days.indexOf(day);
    const weekStart = getWeekStartDate(week);
    const dayDate = new Date(weekStart);
    dayDate.setDate(weekStart.getDate() + dayIndex);
    return dayDate;
}

function getSubjectClass(subject) {
    if (!subject || subject === 'Lunch' || subject === 'Form Time') return '';
    
    const normalized = subject.toLowerCase()
        .replace(/\s+/g, '-')
        .replace(/[\/]/g, '-')
        .replace(/[^a-z0-9-]/g, '');
    
    return `subject-${normalized}`;
}

function parseTime(timeStr) {
    if (!timeStr) return null;
    const match = timeStr.match(/(\d{1,2}):(\d{2})/);
    if (!match) return null;
    
    const hours = parseInt(match[1]);
    const minutes = parseInt(match[2]);
    return { hours, minutes };
}

function isCurrentTime(timeRange) {
    if (!timeRange) return false;
    
    const now = new Date();
    const currentHours = now.getHours();
    const currentMinutes = now.getMinutes();
    
    const times = timeRange.split(' - ');
    if (times.length !== 2) return false;
    
    const startTime = parseTime(times[0]);
    const endTime = parseTime(times[1]);
    
    if (!startTime || !endTime) return false;
    
    const currentTotalMinutes = currentHours * 60 + currentMinutes;
    const startTotalMinutes = startTime.hours * 60 + startTime.minutes;
    const endTotalMinutes = endTime.hours * 60 + endTime.minutes;
    
    return currentTotalMinutes >= startTotalMinutes && currentTotalMinutes < endTotalMinutes;
}

function getNextPeriod(currentPeriodIndex, day, week) {
    for (let i = currentPeriodIndex + 1; i < periods.length; i++) {
        const period = periods[i];
        const weekData = week === 'A' ? timetableData.weekA : timetableData.weekB;
        if (weekData[day] && weekData[day][period]) {
            return { period, index: i };
        }
    }
    return null;
}

function getNextTerm() {
    const now = new Date();
    for (let term of schoolTerms) {
        // Check if the current date is before or within the term period
        if (now < term.endDate) {
            return term;
        }
    }
    return null; // No more terms or all terms have passed
}

function calculateWeeksBetween(startDate, endDate) {
    const msInWeek = 1000 * 60 * 60 * 24 * 7;
    const diffMs = endDate.getTime() - startDate.getTime();
    return Math.floor(diffMs / msInWeek);
}

function calculateBusinessDays(startDate, endDate) {
    let count = 0;
    const curDate = new Date(startDate.getTime());
    while (curDate <= endDate) {
        const dayOfWeek = curDate.getDay();
        if (dayOfWeek !== 0 && dayOfWeek !== 6) count++; // 0 = Sunday, 6 = Saturday
        curDate.setDate(curDate.getDate() + 1);
    }
    return count;
}

function formatTermDates(term) {
    const startDay = term.startDate.getDate();
    const startMonth = term.startDate.toLocaleDateString('en-US', { month: 'short' });
    const endDay = term.endDate.getDate();
    const endMonth = term.endDate.toLocaleDateString('en-US', { month: 'short' });
    const year = term.startDate.getFullYear();
    
    const now = new Date();
    let weeksRemaining = 0;
    if (now < term.startDate) {
        weeksRemaining = Math.ceil(calculateBusinessDays(now, term.startDate) / 5);
    } else if (now >= term.startDate && now <= term.endDate) {
                weeksRemaining = Math.ceil(calculateBusinessDays(now, term.endDate) / 5);
    }

    const weekText = weeksRemaining === 1 ? '1 week' : `${weeksRemaining} weeks`;
    
    return `${startDay} ${startMonth} - ${endDay} ${endMonth} ${year} (${weekText} remaining)`;
}

// UI update functions
function updateClock() {
    const now = new Date();
    const hoursElement = document.getElementById('hours');
    const minutesElement = document.getElementById('minutes');
    const secondsElement = document.getElementById('seconds');
    const dateElement = document.getElementById('date-info');
    const weekElement = document.getElementById('week-info');
    
    if (hoursElement && minutesElement && secondsElement) {
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const seconds = now.getSeconds().toString().padStart(2, '0');
        
        hoursElement.textContent = hours;
        minutesElement.textContent = minutes;
        secondsElement.textContent = seconds;
    }
    
    if (dateElement) {
        dateElement.textContent = formatDate(now);
    }
    
    if (weekElement) {
        const displayWeek = getCurrentWeek();
        weekElement.textContent = `Current Week: ${displayWeek}`;
    }
    
    // Update countdown for next term
    const nextTerm = getNextTerm();
    if (nextTerm) {
        const timeDiff = nextTerm.startDate.getTime() - now.getTime();
        if (timeDiff > 0) {
                        const days = calculateBusinessDays(now, nextTerm.startDate);
            const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
            
            document.getElementById('countdown-title').textContent = nextTerm.name;
            document.getElementById('countdown-subtitle').textContent = formatTermDates(nextTerm);
            document.getElementById('countdown-days').textContent = days.toString().padStart(3, '0');
            document.getElementById('countdown-hours').textContent = hours.toString().padStart(2, '0');
            document.getElementById('countdown-minutes').textContent = minutes.toString().padStart(2, '0');
            document.getElementById('countdown-seconds').textContent = seconds.toString().padStart(2, '0');
        } else {
            // If the current time is within the term, show 000 days etc.
            // Or if it's past the last term, show all zeros
            document.getElementById('countdown-title').textContent = nextTerm.name;
            document.getElementById('countdown-subtitle').textContent = formatTermDates(nextTerm);
            document.getElementById('countdown-days').textContent = "000";
            document.getElementById('countdown-hours').textContent = "00";
            document.getElementById('countdown-minutes').textContent = "00";
            document.getElementById('countdown-seconds').textContent = "00";
        }
    } else {
        document.getElementById('countdown-title').textContent = "No More Terms";
        document.getElementById('countdown-subtitle').textContent = "Academic year completed";
        document.getElementById('countdown-days').textContent = "000";
        document.getElementById('countdown-hours').textContent = "00";
        document.getElementById('countdown-minutes').textContent = "00";
        document.getElementById('countdown-seconds').textContent = "00";
    }
}

function updateWeekButtons() {
    // Update control buttons
    const controlButtons = document.querySelectorAll('.control-btn');
    controlButtons.forEach(btn => {
        btn.classList.remove('active');
        const week = btn.dataset.week;
        if ((currentMode === 'auto' && week === 'auto') ||
            (currentMode === 'manual' && week === currentWeek)) {
            btn.classList.add('active');
        }
    });
    
    // Update legacy week buttons (for backward compatibility)
    const buttons = document.querySelectorAll('.week-btn');
    buttons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.week === currentMode || 
            (currentMode === 'auto' && btn.dataset.week === 'auto')) {
            btn.classList.add('active');
        }
    });
}

function generateTimetable() {
    const week = getCurrentWeek();
    const weekData = week === 'A' ? timetableData.weekA : timetableData.weekB;
    const table = document.getElementById('timetable');
    
    let html = '<thead><tr>';
    html += '<th class="period-header">Period</th>';
    html += '<th class="time-cell">Time</th>';
    
    days.forEach(day => {
        const dayDate = getDayDate(day, week);
        html += `<th class="day-header" colspan="2">
            <div class="day-header">${day}</div>
            <div class="date-header">${dayDate.getDate()} ${dayDate.toLocaleDateString('en-US', { month: 'short' })} ${dayDate.getFullYear()}</div>
        </th>`;
    });
    
    html += '</tr><tr>';
    html += '<th class="period-header"></th>';
    html += '<th class="time-cell"></th>';
    
    days.forEach(() => {
        html += '<th class="period-header">Ms K Arakalian</th>';
        html += '<th class="period-header">Ms N. Jenkins</th>';
    });
    
    html += '</tr></thead><tbody>';
    
    periods.forEach(period => {
        html += '<tr>';
        
        // Period column
        html += `<td class="period-header">${period}</td>`;
        
        // Time column
        const timeData = weekData[days[0]] && weekData[days[0]][period] ? weekData[days[0]][period].time : '';
        html += `<td class="time-cell">${timeData}</td>`;
        
        // Day columns
        days.forEach(day => {
            teachers.forEach(teacher => {
                const dayData = weekData[day];
                const periodData = dayData && dayData[period];
                const teacherData = periodData && periodData.teachers && periodData.teachers[teacher];
                
                let cellClass = 'subject-cell';
                let cellContent = '';
                
                if (teacherData) {
                    const subject = teacherData.subject || '';
                    const room = teacherData.room || '';
                    
                    if (subject === 'Form Time') {
                        cellClass += ' form-time';
                        cellContent = '<div class="subject-name">Form Time</div>';
                    } else if (subject === 'Lunch') {
                        cellClass += ' lunch';
                        cellContent = '<div class="subject-name">Lunch</div>';
                    } else if (subject) {
                        cellClass += ` ${getSubjectClass(subject)}`;
                        cellContent = `\n                            <div class="subject-name">${subject}</div>\n                            ${room ? `<div class="room-name">${room}</div>` : ''}\n                        `;
                    }
                }
                
                // Check if this lesson has a request using the new database system
                if (window.teacherRequestDB) {
                    const requestData = window.teacherRequestDB.getRequest(week, day, period, teacher);
                    if (requestData && requestData.hasRequest && requestData.status === 'active') {
                        cellClass += ' has-request';
                    }
                }
                
                const cellData = JSON.stringify({
                    subject: teacherData ? teacherData.subject : '',
                    room: teacherData ? teacherData.room : '',
                    teacher: teacher,
                    time: timeData,
                    period: period,
                    day: day,
                    week: week
                });
                
                let breakOverlay = "";
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();

                // Break 1: 10:20 - 10:40 for lessons 7, 8
                if (period === '7' || period === '8') {
                    if ((currentHour === 10 && currentMinute >= 20 && currentMinute < 40)) {
                        cellClass += ' break-active';
                        breakOverlay = '<div class="break-overlay">Break</div>';
                    }
                }
                // Break 2: 10:40 - 11:30 for lessons 9, 10, 11, 12, 13
                if (period === '9' || period === '10' || period === '11' || period === '12' || period === '13') {
                    if ((currentHour === 10 && currentMinute >= 40) || (currentHour === 11 && currentMinute < 30)) {
                        cellClass += ' break-active';
                        breakOverlay = '<div class="break-overlay">Break</div>';
                    }
                }

                html += `<td class="${cellClass}" data-cell=\'${cellData}\' style="position: relative;">${cellContent}${breakOverlay}</td>`;
            });
        });
        
        html += '</tr>';
    });
    
    html += '</tbody>';
    table.innerHTML = html;
    
    // Add click event listeners
    document.querySelectorAll('.subject-cell').forEach(cell => {
        cell.addEventListener('click', function() {
            const data = JSON.parse(this.dataset.cell);
            if (data.subject && data.subject !== 'Lunch') {
                showModal(data);
            }
        });
    });
}

function updateTeacherBoxes() {
    const now = new Date();
    const today = now.toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
    const week = getCurrentWeek();
    const weekData = week === 'A' ? timetableData.weekA : timetableData.weekB;
    const todayData = weekData[today];
    
    if (!todayData) {
        teachers.forEach((teacher, index) => {
            const teacherKey = teacher.toLowerCase().replace(/[.\s]/g, '-');
            const currentElement = document.getElementById(`current-${teacherKey}`);
            const nextElement = document.getElementById(`next-${teacherKey}`);
            if (currentElement) currentElement.textContent = 'No Lesson Now';
            if (nextElement) nextElement.textContent = 'No Lesson Next';
        });
        return;
    }
    
    teachers.forEach(teacher => {
        const teacherKey = teacher === 'Ms K Arakalian' ? 'arakalian' : 'jenkins';
        let currentLesson = 'No Lesson Now';
        let nextLesson = 'No Lesson Next';
        
        // Find current lesson
        let currentPeriodIndex = -1;
        periods.forEach((period, index) => {
            const periodData = todayData[period];
            if (periodData && isCurrentTime(periodData.time)) {
                currentPeriodIndex = index;
                const teacherData = periodData.teachers[teacher];
                if (teacherData && teacherData.subject) {
                    if (teacherData.subject === 'Form Time') {
                        currentLesson = 'Form Time';
                    } else if (teacherData.subject === 'Lunch') {
                        currentLesson = 'Lunch';
                    }
                    else {
                        currentLesson = `${teacherData.subject}${teacherData.room ? ` - ${teacherData.room}` : ''}`;
                    }
                }
            }
        });
        
        // Find next lesson
        if (currentPeriodIndex >= 0) {
            const nextPeriodInfo = getNextPeriod(currentPeriodIndex, today, week);
            if (nextPeriodInfo) {
                const nextPeriodData = todayData[nextPeriodInfo.period];
                const nextTeacherData = nextPeriodData.teachers[teacher];
                if (nextTeacherData && nextTeacherData.subject) {
                    if (nextTeacherData.subject === 'Form Time') {
                        nextLesson = 'Form Time';
                    } else if (nextTeacherData.subject === 'Lunch') {
                        nextLesson = 'Lunch';
                    }
                    else {
                        nextLesson = `${nextTeacherData.subject}${nextTeacherData.room ? ` - ${nextTeacherData.room}` : ''}`;
                    }
                }
            }
        }

        document.getElementById(`current-${teacherKey}`).textContent = currentLesson;
        document.getElementById(`next-${teacherKey}`).textContent = nextLesson;
    });
}

// Dark mode toggle
const darkModeToggle = document.getElementById('dark-mode-toggle');
if (darkModeToggle) {
    darkModeToggle.addEventListener('click', () => {
        document.body.dataset.theme = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
        localStorage.setItem('theme', document.body.dataset.theme);
    });
}

// Initialize theme from local storage
function initTheme() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
        document.body.dataset.theme = savedTheme;
        if (savedTheme === 'dark') {
            darkModeToggle.classList.add('active');
        }
    } else {
        // Default to light theme if no preference is saved
        document.body.dataset.theme = 'light';
    }
}

// Modal functionality
const subjectModal = document.getElementById('subject-modal');
const modalClose = document.getElementById('modal-close');
const modalTitle = document.getElementById('modal-title');
const modalYear = document.getElementById('modal-year');
const modalTeacher = document.getElementById('modal-teacher');
const modalRoom = document.getElementById('modal-room');
const modalTime = document.getElementById('modal-time');
const requestCheckbox = document.getElementById('request-checkbox');
const notesField = document.getElementById('notes-field');
const charCount = document.getElementById('char-count');
const saveRequestBtn = document.getElementById('save-request');
const clearRequestBtn = document.getElementById('clear-request');

function showModal(data) {
    currentModalData = data;
    modalTitle.textContent = data.subject;
    modalYear.textContent = data.subject.match(/^\d{1,2}/) ? data.subject.match(/^\d{1,2}/)[0] : '-';
    modalTeacher.textContent = data.teacher;
    modalRoom.textContent = data.room || 'N/A';
    modalTime.textContent = data.time;

    // Load existing request data
    const request = window.teacherRequestDB.getRequest(data.week, data.day, data.period, data.teacher);
    if (request) {
        requestCheckbox.checked = request.hasRequest;
        notesField.value = request.notes;
    } else {
        requestCheckbox.checked = false;
        notesField.value = '';
    }
    updateCharCount();

    subjectModal.classList.add('show');
}

function closeModal() {
    subjectModal.classList.remove('show');
    currentModalData = null;
}

modalClose.addEventListener('click', closeModal);
window.addEventListener('click', (event) => {
    if (event.target === subjectModal) {
        closeModal();
    }
});

notesField.addEventListener('input', updateCharCount);

function updateCharCount() {
    charCount.textContent = notesField.value.length;
}

saveRequestBtn.addEventListener('click', () => {
    if (currentModalData) {
        window.teacherRequestDB.saveRequest(
            currentModalData.week,
            currentModalData.day,
            currentModalData.period,
            currentModalData.teacher,
            requestCheckbox.checked,
            notesField.value
        );
        generateTimetable(); // Re-render timetable to show request status
        closeModal();
    }
});

clearRequestBtn.addEventListener('click', () => {
    if (currentModalData) {
        window.teacherRequestDB.clearRequest(
            currentModalData.week,
            currentModalData.day,
            currentModalData.period,
            currentModalData.teacher
        );
        generateTimetable(); // Re-render timetable to clear request status
        closeModal();
    }
});

// Initial calls
initTheme();
updateClock();
generateTimetable();
updateTeacherBoxes();

// Update every second
setInterval(() => {
    updateClock();
    // Only regenerate timetable and teacher boxes if the minute changes to avoid excessive DOM manipulation
    const now = new Date();
    if (now.getSeconds() === 0) {
        generateTimetable();
        updateTeacherBoxes();
    }
}, 1000);

// Event listeners for week controls
document.querySelectorAll('.control-btn').forEach(button => {
    button.addEventListener('click', function() {
        const week = this.dataset.week;
        if (week === 'auto') {
            currentMode = 'auto';
        } else {
            currentMode = 'manual';
            currentWeek = week;
        }
        updateWeekButtons();
        generateTimetable();
        updateTeacherBoxes();
    });
});

// Database for teacher requests (using IndexedDB)
class TeacherRequestDB {
    constructor() {
        this.db = null;
        this.dbName = 'TeacherRequestsDB';
        this.storeName = 'requests';
        this.version = 1;
    }

    open() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.version);

            request.onupgradeneeded = (event) => {
                this.db = event.target.result;
                if (!this.db.objectStoreNames.contains(this.storeName)) {
                    const objectStore = this.db.createObjectStore(this.storeName, { keyPath: 'id', autoIncrement: true });
                    objectStore.createIndex('week_day_period_teacher', ['week', 'day', 'period', 'teacher'], { unique: true });
                }
            };

            request.onsuccess = (event) => {
                this.db = event.target.result;
                resolve();
            };

            request.onerror = (event) => {
                console.error('IndexedDB error:', event.target.errorCode);
                reject(event.target.errorCode);
            };
        });
    }

    async saveRequest(week, day, period, teacher, hasRequest, notes) {
        await this.open();
        const transaction = this.db.transaction([this.storeName], 'readwrite');
        const store = transaction.objectStore(this.storeName);
        const index = store.index('week_day_period_teacher');

        const query = index.get([week, day, period, teacher]);

        return new Promise((resolve, reject) => {
            query.onsuccess = (event) => {
                const existingRequest = event.target.result;
                const data = {
                    week, day, period, teacher, hasRequest, notes,
                    timestamp: new Date().toISOString(),
                    status: 'active' // Add status field
                };

                if (existingRequest) {
                    data.id = existingRequest.id; // Keep the same ID for update
                    store.put(data);
                } else {
                    store.add(data);
                }

                transaction.oncomplete = () => resolve();
                transaction.onerror = (e) => reject(e);
            };
            query.onerror = (e) => reject(e);
        });
    }

    async getRequest(week, day, period, teacher) {
        await this.open();
        const transaction = this.db.transaction([this.storeName], 'readonly');
        const store = transaction.objectStore(this.storeName);
        const index = store.index('week_day_period_teacher');

        const query = index.get([week, day, period, teacher]);

        return new Promise((resolve, reject) => {
            query.onsuccess = (event) => resolve(event.target.result);
            query.onerror = (e) => reject(e);
        });
    }

    async clearRequest(week, day, period, teacher) {
        await this.open();
        const transaction = this.db.transaction([this.storeName], 'readwrite');
        const store = transaction.objectStore(this.storeName);
        const index = store.index('week_day_period_teacher');

        const query = index.get([week, day, period, teacher]);

        return new Promise((resolve, reject) => {
            query.onsuccess = (event) => {
                const existingRequest = event.target.result;
                if (existingRequest) {
                    store.delete(existingRequest.id);
                }
                transaction.oncomplete = () => resolve();
                transaction.onerror = (e) => reject(e);
            };
            query.onerror = (e) => reject(e);
        });
    }
}

// Initialize the database
window.teacherRequestDB = new TeacherRequestDB();
window.teacherRequestDB.open().then(() => {
    console.log('IndexedDB opened successfully');
}).catch(error => {
    console.error('Failed to open IndexedDB:', error);
});

// Initial render after DB is ready
window.addEventListener('DOMContentLoaded', () => {
    initTheme();
    updateClock();
    generateTimetable();
    updateTeacherBoxes();
});


