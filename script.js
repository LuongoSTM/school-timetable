// Updated timetable data with corrected Week B data
const timetableData = {
    "weekA": {
        "MONDAY": {
            "Form Time": {
                "time": "09:00 - 09:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Form Time",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "Form Time",
                        "room": "A2"
                    }
                }
            },
            "1": {
                "time": "09:30 - 10:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "12 DT Textile",
                        "room": "T1"
                    },
                    "Ms N Jenkins": {
                        "subject": "11 Photography",
                        "room": "A1"
                    }
                }
            },
            "2": {
                "time": "10:20 - 10:40",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "12 / 13 Art",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "9S DT",
                        "room": "T1"
                    }
                }
            },
            "3": {
                "time": "10:40 - 11:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "9M",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "",
                        "room": ""
                    }
                }
            },
            "4a": {
                "time": "11:30 - 12:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "9A",
                        "room": "A1"
                    }
                }
            },
            "4b": {
                "time": "12:30 - 13:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Lunch",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "Lunch",
                        "room": ""
                    }
                }
            },
            "5": {
                "time": "14:30 - 15:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "12 DT Textile",
                        "room": "T1"
                    },
                    "Ms N Jenkins": {
                        "subject": "10 Art",
                        "room": "A1"
                    }
                }
            }
        },
        "TUESDAY": {
            "Form Time": {
                "time": "09:00 - 09:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Form Time",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "Form Time",
                        "room": "A2"
                    }
                }
            },
            "1": {
                "time": "09:30 - 10:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "9S",
                        "room": "A2"
                    },
                    "Ms N Jenkins": {
                        "subject": "11 Photography",
                        "room": "A1"
                    }
                }
            },
            "2": {
                "time": "10:20 - 10:40",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "7AC",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "7AC DT",
                        "room": "A2"
                    }
                }
            },
            "3": {
                "time": "10:40 - 11:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "11 Art",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "",
                        "room": ""
                    }
                }
            },
            "4a": {
                "time": "11:30 - 12:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Lunch",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "Lunch",
                        "room": ""
                    }
                }
            },
            "4b": {
                "time": "12:30 - 13:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "8AC",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "8AC DT",
                        "room": "A2"
                    }
                }
            },
            "5": {
                "time": "14:30 - 15:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "9AC DT",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "",
                        "room": ""
                    }
                }
            }
        },
        "WEDNESDAY": {
            "Form Time": {
                "time": "09:00 - 09:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Form Time",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "Form Time",
                        "room": "A2"
                    }
                }
            },
            "1": {
                "time": "09:30 - 10:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "9HM Food",
                        "room": "HE1"
                    },
                    "Ms N Jenkins": {
                        "subject": "9C",
                        "room": "A2"
                    }
                }
            },
            "2": {
                "time": "10:20 - 10:40",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "7AC",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "7AC DT",
                        "room": "A2"
                    }
                }
            },
            "3": {
                "time": "10:40 - 11:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "11 Photography",
                        "room": "A1"
                    }
                }
            },
            "4a": {
                "time": "11:30 - 12:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Lunch",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "Lunch",
                        "room": ""
                    }
                }
            },
            "4b": {
                "time": "12:30 - 13:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "7H",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "7H DT",
                        "room": "A2"
                    }
                }
            },
            "5": {
                "time": "14:30 - 15:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "11 Art",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "",
                        "room": ""
                    }
                }
            }
        },
        "THURSDAY": {
            "Form Time": {
                "time": "09:00 - 09:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Form Time",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "Form Time",
                        "room": "A2"
                    }
                }
            },
            "1": {
                "time": "09:30 - 10:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "10 Art",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "9H",
                        "room": "A2"
                    }
                }
            },
            "2": {
                "time": "10:20 - 10:40",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "10 Art",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "",
                        "room": ""
                    }
                }
            },
            "3": {
                "time": "10:40 - 11:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "11 Art",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "",
                        "room": ""
                    }
                }
            },
            "4a": {
                "time": "11:30 - 12:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Lunch",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "Lunch",
                        "room": ""
                    }
                }
            },
            "4b": {
                "time": "12:30 - 13:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "12 / 13 Art",
                        "room": "A1"
                    }
                }
            },
            "5": {
                "time": "14:30 - 15:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "8Y",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "8Y DT",
                        "room": "A2"
                    }
                }
            }
        },
        "FRIDAY": {
            "Form Time": {
                "time": "09:00 - 09:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Form Time",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "Form Time",
                        "room": "A2"
                    }
                }
            },
            "1": {
                "time": "09:30 - 10:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "7MS",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "7MS DT",
                        "room": "A2"
                    }
                }
            },
            "2": {
                "time": "10:20 - 10:40",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "8HM",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "8HM DT",
                        "room": "A2"
                    }
                }
            },
            "3": {
                "time": "10:40 - 11:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "8AC",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "8AC DT",
                        "room": "A2"
                    }
                }
            },
            "4a": {
                "time": "11:30 - 12:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Lunch",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "Lunch",
                        "room": ""
                    }
                }
            },
            "4b": {
                "time": "12:30 - 13:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "7H",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "7H DT",
                        "room": "A2"
                    }
                }
            },
            "5": {
                "time": "14:30 - 15:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "9AC DT",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "12 / 13 Art",
                        "room": "A2"
                    }
                }
            }
        }
    },
    "weekB": {
        "MONDAY": {
            "Form Time": {
                "time": "09:00 - 09:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Form Time",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "Form Time",
                        "room": "A2"
                    }
                }
            },
            "1": {
                "time": "09:30 - 10:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "8Y",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "8Y DT",
                        "room": "A2"
                    }
                }
            },
            "2": {
                "time": "10:20 - 10:40",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "9S",
                        "room": "A2"
                    },
                    "Ms N Jenkins": {
                        "subject": "12 / 13 Art",
                        "room": "A1"
                    }
                }
            },
            "3": {
                "time": "10:40 - 11:10",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "7MS",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "7MS DT",
                        "room": "A2"
                    }
                }
            },
            "4a": {
                "time": "12:30 - 13:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "Lunch",
                        "room": ""
                    }
                }
            },
            "4b": {
                "time": "13:30 - 14:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Lunch",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "12 / 13 Art",
                        "room": "A1"
                    }
                }
            },
            "5": {
                "time": "14:30 - 15:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "9S Food",
                        "room": "HE1"
                    },
                    "Ms N Jenkins": {
                        "subject": "",
                        "room": ""
                    }
                }
            }
        },
        "TUESDAY": {
            "Form Time": {
                "time": "09:00 - 09:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Form Time",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "Form Time",
                        "room": "A2"
                    }
                }
            },
            "1": {
                "time": "09:30 - 10:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "10 Art",
                        "room": "A1"
                    }
                }
            },
            "2": {
                "time": "10:20 - 10:40",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "PSHE",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "PSHE",
                        "room": "A2"
                    }
                }
            },
            "3": {
                "time": "10:40 - 11:10",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "11 Photography",
                        "room": "A1"
                    }
                }
            },
            "4a": {
                "time": "12:30 - 13:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Lunch",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "Lunch",
                        "room": ""
                    }
                }
            },
            "4b": {
                "time": "13:30 - 14:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "12 / 13 Art",
                        "room": "A1"
                    }
                }
            },
            "5": {
                "time": "14:30 - 15:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "11 Art",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "",
                        "room": ""
                    }
                }
            }
        },
        "WEDNESDAY": {
            "Form Time": {
                "time": "09:00 - 09:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Form Time",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "Form Time",
                        "room": "A2"
                    }
                }
            },
            "1": {
                "time": "09:30 - 10:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "10 Art",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "",
                        "room": ""
                    }
                }
            },
            "2": {
                "time": "10:20 - 10:40",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "11 Art",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "9C",
                        "room": "A2"
                    }
                }
            },
            "3": {
                "time": "10:40 - 11:10",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "8Y",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "8Y DT",
                        "room": "A2"
                    }
                }
            },
            "4a": {
                "time": "12:30 - 13:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "9M",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "Lunch",
                        "room": ""
                    }
                }
            },
            "4b": {
                "time": "13:30 - 14:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Lunch",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "12 / 13 Art",
                        "room": "A1"
                    }
                }
            },
            "5": {
                "time": "14:30 - 15:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "9A",
                        "room": "A2"
                    }
                }
            }
        },
        "THURSDAY": {
            "Form Time": {
                "time": "09:00 - 09:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Form Time",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "Form Time",
                        "room": "A2"
                    }
                }
            },
            "1": {
                "time": "09:30 - 10:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "9S Food",
                        "room": "HE1"
                    },
                    "Ms N Jenkins": {
                        "subject": "",
                        "room": ""
                    }
                }
            },
            "2": {
                "time": "10:20 - 10:40",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "12 / 13 Art",
                        "room": "A2"
                    },
                    "Ms N Jenkins": {
                        "subject": "11 Photography",
                        "room": "A1"
                    }
                }
            },
            "3": {
                "time": "10:40 - 11:10",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "9AC DT",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "9H",
                        "room": "A2"
                    }
                }
            },
            "4a": {
                "time": "12:30 - 13:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Lunch",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "Lunch",
                        "room": ""
                    }
                }
            },
            "4b": {
                "time": "13:30 - 14:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "8HM",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "8HM DT",
                        "room": "A2"
                    }
                }
            },
            "5": {
                "time": "14:30 - 15:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "7MS",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "7MS DT",
                        "room": "A2"
                    }
                }
            }
        },
        "FRIDAY": {
            "Form Time": {
                "time": "09:00 - 09:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Form Time",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "Form Time",
                        "room": "A2"
                    }
                }
            },
            "1": {
                "time": "09:30 - 10:20",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "7AC",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "7AC DT",
                        "room": "A2"
                    }
                }
            },
            "2": {
                "time": "10:20 - 10:40",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "8AC",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "8AC DT",
                        "room": "A2"
                    }
                }
            },
            "3": {
                "time": "10:40 - 11:10",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "8MH",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "8HM DT",
                        "room": "A2"
                    }
                }
            },
            "4a": {
                "time": "12:30 - 13:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "Lunch",
                        "room": ""
                    },
                    "Ms N Jenkins": {
                        "subject": "Lunch",
                        "room": ""
                    }
                }
            },
            "4b": {
                "time": "13:30 - 14:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "7H",
                        "room": "A1"
                    },
                    "Ms N Jenkins": {
                        "subject": "7H DT",
                        "room": "A2"
                    }
                }
            },
            "5": {
                "time": "14:30 - 15:30",
                "teachers": {
                    "Ms K Arakalian": {
                        "subject": "9HM Food",
                        "room": "HE1"
                    },
                    "Ms N Jenkins": {
                        "subject": "9HM DT",
                        "room": "A2"
                    }
                }
            }
        }
    }
};

// Global variables - Updated start dates
let currentMode = 'auto';
let currentWeek = 'A';
let currentModalData = null;
const weekAStartDate = new Date(2025, 8, 1); // September 1, 2025 (month is 0-indexed)
const weekBStartDate = new Date(2025, 8, 8); // September 8, 2025 (month is 0-indexed)

// School term dates with corrected dates
const schoolTerms = [
    {
        name: "October Half Term",
        startDate: new Date(2025, 9, 27), // October 27, 2025
        endDate: new Date(2025, 9, 31)    // October 31, 2025
    },
    {
        name: "Christmas Term",
        startDate: new Date(2025, 11, 22), // December 22, 2025
        endDate: new Date(2026, 0, 2)      // January 2, 2026
    },
    {
        name: "February Half Term",
        startDate: new Date(2026, 1, 16), // February 16, 2026
        endDate: new Date(2026, 1, 20)    // February 20, 2026
    },
    {
        name: "Easter Term",
        startDate: new Date(2026, 2, 30), // March 30, 2026
        endDate: new Date(2026, 3, 10)    // April 10, 2026
    },
    {
        name: "May Half Term",
        startDate: new Date(2026, 4, 25), // May 25, 2026
        endDate: new Date(2026, 4, 29)    // May 29, 2026
    },
    {
        name: "Summer Term",
        startDate: new Date(2026, 6, 20), // July 20, 2026
        endDate: new Date(2026, 7, 31)    // August 31, 2026
    }
];

const teachers = ['Ms K Arakalian', 'Ms N Jenkins'];
const days = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY'];
const periods = ['Form Time', '1', '2', '3', '4a', '4b', '5'];

// Local storage functions for lesson requests
function getLessonRequestKey(week, day, period, teacher) {
    return `lesson_request_${week}_${day}_${period}_${teacher.replace(/\s+/g, '_')}`;
}

function saveLessonRequest(week, day, period, teacher, hasRequest, notes) {
    const key = getLessonRequestKey(week, day, period, teacher);
    const data = {
        hasRequest: hasRequest,
        notes: notes,
        timestamp: new Date().toISOString()
    };
    localStorage.setItem(key, JSON.stringify(data));
}

function getLessonRequest(week, day, period, teacher) {
    const key = getLessonRequestKey(week, day, period, teacher);
    const data = localStorage.getItem(key);
    if (data) {
        try {
            return JSON.parse(data);
        } catch (e) {
            return null;
        }
    }
    return null;
}

function clearLessonRequest(week, day, period, teacher) {
    const key = getLessonRequestKey(week, day, period, teacher);
    localStorage.removeItem(key);
}

// Utility functions
function isWeekA(date) {
    const diffTime = date.getTime() - weekAStartDate.getTime();
    const diffWeeks = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7));
    return diffWeeks % 2 === 0;
}

function getCurrentWeek() {
    if (currentMode === 'auto') {
        return isWeekA(new Date()) ? 'A' : 'B';
    }
    return currentWeek;
}

function formatDate(date) {
    const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    };
    return date.toLocaleDateString('en-US', options);
}

function formatTime(date) {
    return date.toLocaleTimeString('en-US', { 
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}

function getWeekStartDate(week, referenceDate = new Date()) {
    if (week === 'A') {
        return new Date(weekAStartDate);
    } else {
        return new Date(weekBStartDate);
    }
}

function getDayDate(day, week) {
    const dayIndex = days.indexOf(day);
    const weekStart = getWeekStartDate(week);
    const dayDate = new Date(weekStart);
    dayDate.setDate(weekStart.getDate() + dayIndex);
    return dayDate;
}

function getSubjectClass(subject) {
    if (!subject || subject === 'Lunch' || subject === 'Form Time') return '';
    
    const normalized = subject.toLowerCase()
        .replace(/\s+/g, '-')
        .replace(/[\/]/g, '-')
        .replace(/[^a-z0-9-]/g, '');
    
    return `subject-${normalized}`;
}

function parseTime(timeStr) {
    if (!timeStr) return null;
    const match = timeStr.match(/(\d{1,2}):(\d{2})/);
    if (!match) return null;
    
    const hours = parseInt(match[1]);
    const minutes = parseInt(match[2]);
    return { hours, minutes };
}

function isCurrentTime(timeRange) {
    if (!timeRange) return false;
    
    const now = new Date();
    const currentHours = now.getHours();
    const currentMinutes = now.getMinutes();
    
    const times = timeRange.split(' - ');
    if (times.length !== 2) return false;
    
    const startTime = parseTime(times[0]);
    const endTime = parseTime(times[1]);
    
    if (!startTime || !endTime) return false;
    
    const currentTotalMinutes = currentHours * 60 + currentMinutes;
    const startTotalMinutes = startTime.hours * 60 + startTime.minutes;
    const endTotalMinutes = endTime.hours * 60 + endTime.minutes;
    
    return currentTotalMinutes >= startTotalMinutes && currentTotalMinutes < endTotalMinutes;
}

function getNextPeriod(currentPeriodIndex, day, week) {
    for (let i = currentPeriodIndex + 1; i < periods.length; i++) {
        const period = periods[i];
        const weekData = week === 'A' ? timetableData.weekA : timetableData.weekB;
        if (weekData[day] && weekData[day][period]) {
            return { period, index: i };
        }
    }
    return null;
}

function getNextTerm() {
    const now = new Date();
    for (let term of schoolTerms) {
        // Check if the current date is before or within the term period
        if (now < term.endDate) {
            return term;
        }
    }
    return null; // No more terms or all terms have passed
}

function calculateWeeksBetween(startDate, endDate) {
    const msInWeek = 1000 * 60 * 60 * 24 * 7;
    const diffMs = endDate.getTime() - startDate.getTime();
    return Math.floor(diffMs / msInWeek);
}

function formatTermDates(term) {
    const startDay = term.startDate.getDate();
    const startMonth = term.startDate.toLocaleDateString('en-US', { month: 'short' });
    const endDay = term.endDate.getDate();
    const endMonth = term.endDate.toLocaleDateString('en-US', { month: 'short' });
    const year = term.startDate.getFullYear();
    
    const now = new Date();
    let weeksRemaining = 0;
    if (now < term.startDate) {
        weeksRemaining = calculateWeeksBetween(now, term.startDate);
    } else if (now >= term.startDate && now <= term.endDate) {
        weeksRemaining = calculateWeeksBetween(now, term.endDate);
    }

    const weekText = weeksRemaining === 1 ? '1 week' : `${weeksRemaining} weeks`;
    
    return `${startDay} ${startMonth} - ${endDay} ${endMonth} ${year} (${weekText} remaining)`;
}

// UI update functions
function updateClock() {
    const now = new Date();
    const clockElement = document.getElementById('clock');
    const dateElement = document.getElementById('date-info');
    const weekElement = document.getElementById('week-info');
    
    if (clockElement) {
        clockElement.textContent = formatTime(now);
    }
    
    if (dateElement) {
        dateElement.textContent = formatDate(now);
    }
    
    if (weekElement) {
        const displayWeek = getCurrentWeek();
        weekElement.textContent = `Current Week: ${displayWeek}`;
    }
    
    // Update countdown for next term
    const nextTerm = getNextTerm();
    if (nextTerm) {
        const timeDiff = nextTerm.startDate.getTime() - now.getTime();
        if (timeDiff > 0) {
            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
            
            document.getElementById('countdown-title').textContent = nextTerm.name;
            document.getElementById('countdown-subtitle').textContent = formatTermDates(nextTerm);
            document.getElementById('countdown-days').textContent = days.toString().padStart(3, '0');
            document.getElementById('countdown-hours').textContent = hours.toString().padStart(2, '0');
            document.getElementById('countdown-minutes').textContent = minutes.toString().padStart(2, '0');
            document.getElementById('countdown-seconds').textContent = seconds.toString().padStart(2, '0');
        } else {
            // If the current time is within the term, show 000 days etc.
            // Or if it's past the last term, show all zeros
            document.getElementById('countdown-title').textContent = nextTerm.name;
            document.getElementById('countdown-subtitle').textContent = formatTermDates(nextTerm);
            document.getElementById('countdown-days').textContent = "000";
            document.getElementById('countdown-hours').textContent = "00";
            document.getElementById('countdown-minutes').textContent = "00";
            document.getElementById('countdown-seconds').textContent = "00";
        }
    } else {
        document.getElementById('countdown-title').textContent = "No More Terms";
        document.getElementById('countdown-subtitle').textContent = "Academic year completed";
        document.getElementById('countdown-days').textContent = "000";
        document.getElementById('countdown-hours').textContent = "00";
        document.getElementById('countdown-minutes').textContent = "00";
        document.getElementById('countdown-seconds').textContent = "00";
    }
}

function updateWeekButtons() {
    const buttons = document.querySelectorAll('.week-btn');
    buttons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.week === currentMode || 
            (currentMode === 'auto' && btn.dataset.week === 'auto')) {
            btn.classList.add('active');
        }
    });
}

function generateTimetable() {
    const week = getCurrentWeek();
    const weekData = week === 'A' ? timetableData.weekA : timetableData.weekB;
    const table = document.getElementById('timetable');
    
    let html = '<thead><tr>';
    html += '<th class="period-header">Period</th>';
    html += '<th class="time-cell">Time</th>';
    
    days.forEach(day => {
        const dayDate = getDayDate(day, week);
        html += `<th class="day-header" colspan="2">
            <div class="day-header">${day}</div>
            <div class="date-header">${dayDate.getDate()} ${dayDate.toLocaleDateString('en-US', { month: 'short' })} ${dayDate.getFullYear()}</div>
        </th>`;
    });
    
    html += '</tr><tr>';
    html += '<th class="period-header"></th>';
    html += '<th class="time-cell"></th>';
    
    days.forEach(() => {
        html += '<th class="period-header">Ms K. Arakalian</th>';
        html += '<th class="period-header">Ms N. Jenkins</th>';
    });
    
    html += '</tr></thead><tbody>';
    
    periods.forEach(period => {
        html += '<tr>';
        
        // Period column
        html += `<td class="period-header">${period}</td>`;
        
        // Time column
        const timeData = weekData[days[0]] && weekData[days[0]][period] ? weekData[days[0]][period].time : '';
        html += `<td class="time-cell">${timeData}</td>`;
        
        // Day columns
        days.forEach(day => {
            teachers.forEach(teacher => {
                const dayData = weekData[day];
                const periodData = dayData && dayData[period];
                const teacherData = periodData && periodData.teachers && periodData.teachers[teacher];
                
                let cellClass = 'subject-cell';
                let cellContent = '';
                
                if (teacherData) {
                    const subject = teacherData.subject || '';
                    const room = teacherData.room || '';
                    
                    if (subject === 'Form Time') {
                        cellClass += ' form-time';
                        cellContent = '<div class="subject-name">Form Time</div>';
                    } else if (subject === 'Lunch') {
                        cellClass += ' lunch';
                        cellContent = '<div class="subject-name">Lunch</div>';
                    } else if (subject) {
                        cellClass += ` ${getSubjectClass(subject)}`;
                        cellContent = `
                            <div class="subject-name">${subject}</div>
                            ${room ? `<div class="room-name">${room}</div>` : ''}
                        `;
                    }
                }
                
                // Check if this lesson has a request
                const requestData = getLessonRequest(week, day, period, teacher);
                if (requestData && requestData.hasRequest) {
                    cellClass += ' has-request';
                }
                
                const cellData = JSON.stringify({
                    subject: teacherData ? teacherData.subject : '',
                    room: teacherData ? teacherData.room : '',
                    teacher: teacher,
                    time: timeData,
                    period: period,
                    day: day,
                    week: week
                });
                
                html += `<td class="${cellClass}" data-cell='${cellData}'>${cellContent}</td>`;
            });
        });
        
        html += '</tr>';
    });
    
    html += '</tbody>';
    table.innerHTML = html;
    
    // Add click event listeners
    document.querySelectorAll('.subject-cell').forEach(cell => {
        cell.addEventListener('click', function() {
            const data = JSON.parse(this.dataset.cell);
            if (data.subject && data.subject !== 'Lunch') {
                showModal(data);
            }
        });
    });
}

function updateTeacherBoxes() {
    const now = new Date();
    const today = now.toLocaleDateString('en-US', { weekday: 'long' }).toUpperCase();
    const week = getCurrentWeek();
    const weekData = week === 'A' ? timetableData.weekA : timetableData.weekB;
    const todayData = weekData[today];
    
    if (!todayData) {
        teachers.forEach((teacher, index) => {
            const teacherKey = teacher.toLowerCase().replace(/[.\s]/g, '-');
            const currentElement = document.getElementById(`current-${teacherKey}`);
            const nextElement = document.getElementById(`next-${teacherKey}`);
            if (currentElement) currentElement.textContent = 'No Lesson Now';
            if (nextElement) nextElement.textContent = 'No Lesson Next';
        });
        return;
    }
    
    teachers.forEach(teacher => {
        const teacherKey = teacher === 'Ms K Arakalian' ? 'arakalian' : 'jenkins';
        let currentLesson = 'No Lesson Now';
        let nextLesson = 'No Lesson Next';
        
        // Find current lesson
        let currentPeriodIndex = -1;
        periods.forEach((period, index) => {
            const periodData = todayData[period];
            if (periodData && isCurrentTime(periodData.time)) {
                currentPeriodIndex = index;
                const teacherData = periodData.teachers[teacher];
                if (teacherData && teacherData.subject) {
                    if (teacherData.subject === 'Form Time') {
                        currentLesson = 'Form Time';
                    } else if (teacherData.subject === 'Lunch') {
                        currentLesson = 'Lunch';
                    } else {
                        currentLesson = `${teacherData.subject}${teacherData.room ? ` - ${teacherData.room}` : ''}`;
                    }
                }
            }
        });
        
        // Find next lesson
        if (currentPeriodIndex >= 0) {
            const nextPeriodInfo = getNextPeriod(currentPeriodIndex, today, week);
            if (nextPeriodInfo) {
                const nextPeriodData = todayData[nextPeriodInfo.period];
                const nextTeacherData = nextPeriodData.teachers[teacher];
                if (nextTeacherData && nextTeacherData.subject) {
                    if (nextTeacherData.subject === 'Form Time') {
                        nextLesson = 'Form Time';
                    } else if (nextTeacherData.subject === 'Lunch') {
                        nextLesson = 'Lunch';
                    } else {
                        nextLesson = `${nextTeacherData.subject}${nextTeacherData.room ? ` - ${nextTeacherData.room}` : ''}`;
                    }
                }
            }
        } else {
            // No current lesson, find the next one
            periods.forEach((period, index) => {
                if (nextLesson === 'No Lesson Next') {
                    const periodData = todayData[period];
                    if (periodData) {
                        const startTime = parseTime(periodData.time.split(' - ')[0]);
                        if (startTime) {
                            const currentTotalMinutes = now.getHours() * 60 + now.getMinutes();
                            const startTotalMinutes = startTime.hours * 60 + startTime.minutes;
                            
                            if (currentTotalMinutes < startTotalMinutes) {
                                const teacherData = periodData.teachers[teacher];
                                if (teacherData && teacherData.subject) {
                                    if (teacherData.subject === 'Form Time') {
                                        nextLesson = 'Form Time';
                                    } else if (teacherData.subject === 'Lunch') {
                                        nextLesson = 'Lunch';
                                    } else {
                                        nextLesson = `${teacherData.subject}${teacherData.room ? ` - ${teacherData.room}` : ''}`;
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }
        
        const currentElement = document.getElementById(`current-${teacherKey}`);
        const nextElement = document.getElementById(`next-${teacherKey}`);
        if (currentElement) currentElement.textContent = currentLesson;
        if (nextElement) nextElement.textContent = nextLesson;
    });
}

function showModal(data) {
    currentModalData = data;
    const modal = document.getElementById('subject-modal');
    document.getElementById('modal-title').textContent = data.subject;
    
    // Extract year from subject
    const yearMatch = data.subject.match(/(\d+)/);
    const year = yearMatch ? `Year ${yearMatch[1]}` : '-';
    
    document.getElementById('modal-year').textContent = year;
    document.getElementById('modal-teacher').textContent = data.teacher;
    document.getElementById('modal-room').textContent = data.room || '-';
    document.getElementById('modal-time').textContent = data.time;
    
    // Load existing request data
    const requestData = getLessonRequest(data.week, data.day, data.period, data.teacher);
    const checkbox = document.getElementById('request-checkbox');
    const notesField = document.getElementById('notes-field');
    const charCount = document.getElementById('char-count');
    
    if (requestData) {
        checkbox.checked = requestData.hasRequest;
        notesField.value = requestData.notes || '';
        charCount.textContent = (requestData.notes || '').length;
    } else {
        checkbox.checked = false;
        notesField.value = '';
        charCount.textContent = '0';
    }
    
    modal.style.display = 'block';
}

function hideModal() {
    document.getElementById('subject-modal').style.display = 'none';
    currentModalData = null;
}

function saveRequest() {
    if (!currentModalData) return;
    
    const checkbox = document.getElementById('request-checkbox');
    const notesField = document.getElementById('notes-field');
    const hasRequest = checkbox.checked;
    const notes = notesField.value.trim();
    
    saveLessonRequest(
        currentModalData.week,
        currentModalData.day,
        currentModalData.period,
        currentModalData.teacher,
        hasRequest,
        notes
    );
    
    // Refresh the timetable to show/hide the blinking effect
    generateTimetable();
    
    hideModal();
}

function clearRequest() {
    if (!currentModalData) return;
    
    clearLessonRequest(
        currentModalData.week,
        currentModalData.day,
        currentModalData.period,
        currentModalData.teacher
    );
    
    // Reset form
    document.getElementById('request-checkbox').checked = false;
    document.getElementById('notes-field').value = '';
    document.getElementById('char-count').textContent = '0';
    
    // Refresh the timetable to remove the blinking effect
    generateTimetable();
    
    hideModal();
}

function toggleDarkMode() {
    const body = document.body;
    const toggle = document.getElementById('dark-mode-toggle');
    
    if (body.hasAttribute('data-theme')) {
        body.removeAttribute('data-theme');
        toggle.classList.remove('active');
        localStorage.setItem('darkMode', 'false');
    } else {
        body.setAttribute('data-theme', 'dark');
        toggle.classList.add('active');
        localStorage.setItem('darkMode', 'true');
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Load dark mode preference
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.setAttribute('data-theme', 'dark');
        const toggle = document.getElementById('dark-mode-toggle');
        if (toggle) toggle.classList.add('active');
    }
    
    // Week button event listeners
    document.querySelectorAll('.week-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const week = this.dataset.week;
            if (week === 'auto') {
                currentMode = 'auto';
            } else {
                currentMode = 'manual';
                currentWeek = week;
            }
            updateWeekButtons();
            generateTimetable();
            updateTeacherBoxes();
        });
    });
    
    // Dark mode toggle
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    if (darkModeToggle) {
        darkModeToggle.addEventListener('click', toggleDarkMode);
    }
    
    // Modal event listeners
    const modalClose = document.getElementById('modal-close');
    const modal = document.getElementById('subject-modal');
    const saveBtn = document.getElementById('save-request');
    const clearBtn = document.getElementById('clear-request');
    const notesField = document.getElementById('notes-field');
    const charCount = document.getElementById('char-count');
    
    if (modalClose) {
        modalClose.addEventListener('click', hideModal);
    }
    
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                hideModal();
            }
        });
    }
    
    if (saveBtn) {
        saveBtn.addEventListener('click', saveRequest);
    }
    
    if (clearBtn) {
        clearBtn.addEventListener('click', clearRequest);
    }
    
    if (notesField && charCount) {
        notesField.addEventListener('input', function() {
            charCount.textContent = this.value.length;
        });
    }
    
    // Initial setup
    updateWeekButtons();
    generateTimetable();
    updateClock();
    updateTeacherBoxes();
    
    // Display current user if logged in
    const currentUser = sessionStorage.getItem('currentUser');
    const userInfoElement = document.getElementById('user-info');
    if (currentUser && userInfoElement) {
        userInfoElement.textContent = `Logged in as: ${currentUser}`;
    }
    
    // Update every second
    setInterval(() => {
        updateClock();
        updateTeacherBoxes();
    }, 1000);
});

